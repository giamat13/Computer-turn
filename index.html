<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×—×™×œ×•×§ ×ª×•×¨×•×ª - × ×™×”×•×œ ×–××Ÿ ××—×©×‘ ×œ×™×œ×“×™×</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Alef:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6B4CE6;
            --primary-dark: #5438C7;
            --secondary: #FF6B9D;
            --success: #4ECDC4;
            --warning: #FFD93D;
            --danger: #FF6B6B;
            --bg-main: #F8F9FE;
            --bg-card: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --border: #E2E8F0;
            --shadow: rgba(107, 76, 230, 0.1);
        }

        [data-theme="dark"] {
            --primary: #8B6CE6;
            --primary-dark: #7458D7;
            --secondary: #FF8BB9;
            --success: #6EEDC4;
            --warning: #FFE93D;
            --danger: #FF8B8B;
            --bg-main: #1A202C;
            --bg-card: #2D3748;
            --text-primary: #E2E8F0;
            --text-secondary: #A0AEC0;
            --border: #4A5568;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        [data-theme="ocean"] {
            --primary: #0891B2;
            --primary-dark: #0E7490;
            --secondary: #06B6D4;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg-main: #ECFEFF;
            --bg-card: #FFFFFF;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --border: #CBD5E1;
            --shadow: rgba(8, 145, 178, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Alef', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-family: 'Varela Round', sans-serif;
            color: white;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            font-family: 'Alef', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .tab:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px var(--shadow);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.8rem;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-primary);
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Alef', sans-serif;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(107, 76, 230, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Alef', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--text-primary);
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-main);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            background: #E8ECFF;
            transform: translateX(-5px);
        }

        .list-item button {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .timer-display {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            color: white;
            margin-bottom: 20px;
        }

        .timer-display h2 {
            font-size: 3rem;
            margin-bottom: 10px;
            font-family: 'Varela Round', sans-serif;
            color: white;
            border: none;
        }

        .timer-display .time {
            font-size: 5rem;
            font-weight: bold;
            font-family: 'Varela Round', sans-serif;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.2);
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255,255,255,0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .control-buttons button {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            font-size: 1.1rem;
        }

        .queue-list {
            background: var(--bg-main);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            border-right: 5px solid var(--primary);
        }

        .queue-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-right-color: var(--warning);
        }

        .queue-item .number {
            font-size: 1.5rem;
            font-weight: bold;
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .queue-item.active .number {
            background: var(--warning);
            color: var(--text-primary);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--bg-main);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-card .label {
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .category-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .category-homework {
            background: var(--success);
            color: white;
        }

        .category-coding {
            background: var(--primary);
            color: white;
        }

        .category-gaming {
            background: var(--secondary);
            color: white;
        }

        .category-other {
            background: var(--warning);
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .timer-display .time {
                font-size: 3rem;
            }

            .tabs {
                flex-direction: column;
            }

            .control-buttons {
                flex-direction: column;
            }

            .control-buttons button {
                min-width: 100%;
            }
        }

        .shuffle-btn {
            margin-right: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes flash {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.3; }
        }

        .close-modal {
            float: left;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .rule-item {
            background: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-right: 4px solid var(--primary);
        }

        .rule-item.disabled {
            opacity: 0.6;
            border-right-color: var(--text-secondary);
        }

        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .rule-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .rule-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .rule-formula {
            background: #2D3748;
            color: #48BB78;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .rule-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            right: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(-26px);
        }

        .formula-builder {
            background: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .formula-builder label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .variable-btn {
            background: var(--bg-card);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 8px 12px;
            margin: 3px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .variable-btn:hover {
            background: var(--primary);
            color: white;
        }

        .help-text {
            background: #FFF5E6;
            border-right: 4px solid var(--warning);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .help-text strong {
            color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¥ï¸ ××¢×¨×›×ª ×—×™×œ×•×§ ×ª×•×¨×•×ª ×‘××—×©×‘</h1>

        <div class="tabs">
            <button class="tab active" data-tab="setup">âš™ï¸ ×”×’×“×¨×•×ª</button>
            <button class="tab" data-tab="manage">ğŸ‘¥ × ×™×”×•×œ</button>
            <button class="tab" data-tab="timer">â±ï¸ ×˜×™×™××¨</button>
        </div>

        <!-- Setup Tab -->
        <div class="tab-content active" id="setup">
            <div class="card">
                <h2>×”×’×“×¨×•×ª ××¢×¨×›×ª</h2>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="priorityMode">
                        <label for="priorityMode">×¢×“×™×¤×•×ª ×œ×™×œ×“×™× ×©×¢×•×©×™× ×©×™×¢×•×¨×™× ×¢×œ ×¤× ×™ ××©×—×§×™×</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="defaultTime">×–××Ÿ ×‘×¨×™×¨×ª ××—×“×œ ×œ×›×œ ×™×œ×“ (×“×§×•×ª):</label>
                    <input type="number" id="defaultTime" value="30" min="1">
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="allowPause">
                        <label for="allowPause">××¤×©×¨ ×”×©×”×™×” ×©×œ ×”×˜×™×™××¨</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="allowReset">
                        <label for="allowReset">××¤×©×¨ ××™×¤×•×¡ ×©×œ ×”×˜×™×™××¨</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="showProgress">
                        <label for="showProgress">×”×¦×’ ×§×• ×”×ª×§×“××•×ª</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="showPercent">
                        <label for="showPercent">×”×¦×’ ××—×•×–×™×</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="countDown">
                        <label for="countDown">×¡×¤×™×¨×” ×œ××—×•×¨ (×‘××§×•× ×§×“×™××”)</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="soundAlerts">
                        <label for="soundAlerts">×”×ª×¨××•×ª ×§×•×œ×™×•×ª (×¦×¤×¦×•×£ ×‘×¡×™×•×)</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="visualAlerts">
                        <label for="visualAlerts">×”×ª×¨××•×ª ×•×™×–×•××œ×™×•×ª (×”×‘×”×•×‘ ××¡×š)</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="warningTime">×”×ª×¨××ª ××–×”×¨×” (×“×§×•×ª ×œ×¤× ×™ ×¡×™×•×):</label>
                    <input type="number" id="warningTime" value="2" min="0" max="10">
                </div>

                <div class="form-group">
                    <label for="themeSelect">×¢×¨×›×ª × ×•×©×:</label>
                    <select id="themeSelect">
                        <option value="light">×‘×”×™×¨ (×‘×¨×™×¨×ª ××—×“×œ)</option>
                        <option value="dark">×›×”×”</option>
                        <option value="ocean">××•×§×™×™× ×•×¡</option>
                    </select>
                </div>

                <div style="padding: 15px; background: var(--bg-main); border-radius: 10px; margin-top: 20px;">
                    <p style="color: var(--success); text-align: center; font-weight: bold;">âœ… ×”×”×’×“×¨×•×ª × ×©××¨×•×ª ××•×˜×•××˜×™×ª</p>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
                <button onclick="showStatistics()" class="btn-secondary">ğŸ“ˆ ×”×¦×’ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¤×•×¨×˜×•×ª</button>
                <button onclick="resetStatistics()" class="btn-danger" style="margin-right: 10px;">ğŸ”„ ××¤×¡ ×¡×˜×˜×™×¡×˜×™×§×•×ª</button>
                <button onclick="exportData()" class="btn-success" style="margin-right: 10px;">ğŸ’¾ ×™×™×¦× × ×ª×•× ×™×</button>
            </div>

            <div class="card">
                <h2>×§×˜×’×•×¨×™×•×ª ×¤×¢×™×œ×•×™×•×ª</h2>
                <div id="categoriesList"></div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="newCategory">×”×•×¡×£ ×§×˜×’×•×¨×™×” ×—×“×©×”:</label>
                    <input type="text" id="newCategory" placeholder="×©× ×”×§×˜×’×•×¨×™×”">
                </div>
                <button onclick="addCategory()">â• ×”×•×¡×£ ×§×˜×’×•×¨×™×”</button>
            </div>

            <div class="card">
                <h2>âš–ï¸ ×—×•×§×™× ×•×¢×•× ×©×™×</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    ×”×’×“×¨ ×—×•×§×™× ××•×˜×•××˜×™×™× ×œ××” ×©×§×•×¨×” ×›×©×™×œ×“ × ×©××¨ ××¢×‘×¨ ×œ×–××Ÿ ××• ×™×•×¦× ×œ×¤× ×™ ×”×–××Ÿ
                </p>

                <div id="rulesList"></div>

                <button onclick="openCustomRuleModal()" class="btn-secondary" style="margin-top: 15px;">
                    â• ×¦×•×¨ ×—×•×§ ××•×ª×× ××™×©×™×ª
                </button>
            </div>
        </div>

        <!-- Manage Tab -->
        <div class="tab-content" id="manage">
            <div class="card">
                <h2>×”×•×¡×¤×ª ×™×œ×“×™×</h2>
                
                <div class="form-group">
                    <label for="childName">×©× ×”×™×œ×“:</label>
                    <input type="text" id="childName" placeholder="×”×›× ×¡ ×©×">
                </div>

                <div class="form-group">
                    <label for="childTime">×–××Ÿ ××•×§×¦×” (×“×§×•×ª):</label>
                    <input type="number" id="childTime" placeholder="×‘×¨×™×¨×ª ××—×“×œ">
                </div>

                <div class="form-group">
                    <label for="childActivity">×¤×¢×™×œ×•×ª:</label>
                    <select id="childActivity">
                        <option value="">×œ× × ×‘×—×¨</option>
                    </select>
                </div>

                <button onclick="addChild()">â• ×”×•×¡×£ ×™×œ×“</button>
            </div>

            <div class="card">
                <h2>×¨×©×™××ª ×™×œ×“×™×</h2>
                <div id="childrenList"></div>
            </div>

            <div class="card">
                <h2>××›×©×™×¨×™×</h2>
                
                <div class="form-group">
                    <label for="deviceName">×©× ×”××›×©×™×¨:</label>
                    <input type="text" id="deviceName" placeholder="××—×©×‘ 1, ×˜××‘×œ×˜, ×•×›×•'">
                </div>

                <button onclick="addDevice()">â• ×”×•×¡×£ ××›×©×™×¨</button>
                
                <div id="devicesList" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Timer Tab -->
        <div class="tab-content" id="timer">
            <div class="card">
                <h2>×”×’×“×¨×ª ×‘×•× ×•×¡×™×</h2>
                
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    ×”×’×“×¨ ×‘×•× ×•×¡×™× (××• ×§×™×¦×•×¦×™×) ×œ×›×œ ×™×œ×“ ×œ×¤× ×™ ×”×ª×—×œ×ª ×”×ª×•×¨
                </p>

                <div id="bonusSettings"></div>
            </div>

            <div class="card">
                <h2>×”×¤×¢×œ×ª ×ª×•×¨</h2>
                
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    ×”×ª×•×¨ ×™×§×‘×¢ ×œ×¤×™ ×”×”×’×“×¨×•×ª ×©×œ ×›×œ ×™×œ×“ (×¤×¢×™×œ×•×ª ×•×‘×•× ×•×¡). × ×™×ª×Ÿ ×œ×¢×¨×‘×‘ ××ª ×”×¡×“×¨ ×œ×¤× ×™ ×”×”×ª×—×œ×”.
                </p>

                <div id="activeDevicesInfo" style="display: none; background: var(--bg-main); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: var(--primary); font-size: 1rem; margin-bottom: 10px;">ğŸ“± ××›×©×™×¨×™× ×¤×¢×™×œ×™× ×›×¨×’×¢:</h3>
                    <div id="activeDevicesList"></div>
                </div>

                <button onclick="startQueue()" class="btn-success">ğŸš€ ×”×ª×—×œ ×ª×•×¨</button>
                <button onclick="shuffleQueue()" class="btn-warning shuffle-btn">ğŸ”€ ×¢×¨×‘×‘ ×¡×“×¨</button>
                <button onclick="updateActiveDevicesDisplay()" class="btn-secondary" style="margin-right: 10px;">ğŸ”„ ×¨×¢× ×Ÿ ××›×©×™×¨×™×</button>
            </div>

            <div class="timer-display" id="timerDisplay" style="display: none;">
                <h2 id="currentChildName">-</h2>
                <div class="time" id="timeDisplay">00:00</div>
                
                <div class="progress-bar" id="progressContainer" style="display: none;">
                    <div class="progress-fill" id="progressBar">
                        <span id="percentDisplay"></span>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="value" id="elapsedTime">0:00</div>
                        <div class="label">×–××Ÿ ×©×¢×‘×¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="remainingTime">0:00</div>
                        <div class="label">×–××Ÿ × ×•×ª×¨</div>
                    </div>
                </div>

                <div class="control-buttons">
                    <button onclick="startTimer()" class="btn-success" id="startBtn">â–¶ï¸ ×”×ª×—×œ</button>
                    <button onclick="pauseTimer()" class="btn-warning" id="pauseBtn" style="display: none;">â¸ï¸ ×”×©×”×”</button>
                    <button onclick="resetTimer()" class="btn-danger" id="resetBtn">ğŸ”„ ××™×¤×•×¡</button>
                    <button onclick="nextChild()" class="btn-secondary">â­ï¸ ×”×‘×</button>
                </div>
            </div>

            <div class="card">
                <h2>×ª×•×¨ ×”××ª× ×”</h2>
                <div class="queue-list" id="queueList"></div>
            </div>
        </div>
    </div>

    <!-- Custom Rule Modal -->
    <div class="modal" id="customRuleModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeCustomRuleModal()">Ã—</span>
            <h2 style="color: var(--primary); margin-bottom: 20px;">×¦×•×¨ ×—×•×§ ××•×ª×× ××™×©×™×ª</h2>

            <div class="help-text">
                <strong>ğŸ’¡ ××™×š ×–×” ×¢×•×‘×“?</strong><br>
                <strong>overtime</strong> = ×›××” ×©× ×™×•×ª × ×©××¨ ××¢×‘×¨ ×œ×–××Ÿ (×—×™×•×‘×™) ××• ×›××” ×™×¦× ×œ×¤× ×™ (×©×œ×™×œ×™)<br>
                <strong>nextTurn</strong> = ×–××Ÿ ×”×ª×•×¨ ×”×‘× ×©×œ ×”×™×œ×“ ×‘×©× ×™×•×ª<br>
                <strong>defaultTurn</strong> = ×–××Ÿ ×‘×¨×™×¨×ª ×”××—×“×œ ×‘×©× ×™×•×ª<br>
                <strong>allOthers</strong> = ××©×¤×™×¢ ×¢×œ ×›×œ ×”×™×œ×“×™× ×”××—×¨×™× ×‘×ª×•×¨
            </div>

            <div class="form-group">
                <label for="ruleName">×©× ×”×—×•×§:</label>
                <input type="text" id="ruleName" placeholder="×œ×“×•×’××”: ×¢×•× ×© ×¢×œ ××™×—×•×¨">
            </div>

            <div class="form-group">
                <label for="ruleDescription">×ª×™××•×¨ ×”×—×•×§:</label>
                <input type="text" id="ruleDescription" placeholder="××” ×”×—×•×§ ×¢×•×©×”?">
            </div>

            <div class="formula-builder">
                <label>×ª× ××™ (××ª×™ ×”×—×•×§ ×—×œ?):</label>
                <div style="margin: 10px 0;">
                    <button class="variable-btn" onclick="insertVariable('ruleCondition', 'overtime')">overtime</button>
                    <button class="variable-btn" onclick="insertVariable('ruleCondition', '>')">></button>
                    <button class="variable-btn" onclick="insertVariable('ruleCondition', '<')"><</button>
                    <button class="variable-btn" onclick="insertVariable('ruleCondition', '>=')">>=</button>
                    <button class="variable-btn" onclick="insertVariable('ruleCondition', '<=')"><=</button>
                    <button class="variable-btn" onclick="insertVariable('ruleCondition', '(');">(</button>
                    <button class="variable-btn" onclick="insertVariable('ruleCondition', ')');">)</button>
                    <button class="variable-btn" onclick="insertVariable('ruleCondition', '60')">60 (×©× ×™×•×ª)</button>
                    <button class="variable-btn" onclick="insertVariable('ruleCondition', '300')">300 (5 ×“×§')</button>
                </div>
                <input type="text" id="ruleCondition" placeholder="×œ×“×•×’××”: overtime > 60" style="font-family: monospace;">
            </div>

            <div class="formula-builder">
                <label>×¤×¢×•×œ×” (××” ×§×•×¨×”?):</label>
                <div style="margin: 10px 0;">
                    <button class="variable-btn" onclick="insertVariable('ruleAction', 'nextTurn')">nextTurn</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', 'defaultTurn')">defaultTurn</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', 'allOthers')">allOthers</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', 'overtime')">overtime</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', ' + ')">+</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', ' - ')">-</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', ' * ')">*</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', ' / ')">/</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', '(');">(</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', ')');">)</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', 'Math.abs')">Math.abs</button>
                    <button class="variable-btn" onclick="insertVariable('ruleAction', 'Math.floor')">Math.floor</button>
                </div>
                <input type="text" id="ruleAction" placeholder="×œ×“×•×’××”: nextTurn - overtime - 300" style="font-family: monospace;">
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="saveCustomRule()" class="btn-success">ğŸ’¾ ×©××•×¨ ×—×•×§</button>
                <button onclick="closeCustomRuleModal()" class="btn-secondary">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <!-- Edit Child Modal -->
    <div class="modal" id="editChildModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditChildModal()">Ã—</span>
            <h2 style="color: var(--primary); margin-bottom: 20px;">×¢×¨×•×š ×™×œ×“</h2>

            <input type="hidden" id="editChildId">

            <div class="form-group">
                <label for="editChildName">×©× ×”×™×œ×“:</label>
                <input type="text" id="editChildName" placeholder="×”×›× ×¡ ×©×">
            </div>

            <div class="form-group">
                <label for="editChildTime">×–××Ÿ ××•×§×¦×” (×“×§×•×ª):</label>
                <input type="number" id="editChildTime" placeholder="×‘×¨×™×¨×ª ××—×“×œ">
            </div>

            <div class="form-group">
                <label for="editChildActivity">×¤×¢×™×œ×•×ª:</label>
                <select id="editChildActivity">
                    <option value="">×œ× × ×‘×—×¨</option>
                </select>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="saveEditChild()" class="btn-success">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
                <button onclick="closeEditChildModal()" class="btn-secondary">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script>
        // Data structure
        let settings = {
            priorityMode: false,
            defaultTime: 30,
            allowPause: true,
            allowReset: true,
            showProgress: true,
            showPercent: true,
            countDown: true, // ×¡×¤×™×¨×” ×œ××—×•×¨ ×›×‘×¨×™×¨×ª ××—×“×œ
            soundAlerts: true,
            visualAlerts: true,
            warningTime: 2,
            theme: 'light'
        };

        let categories = ['×©×™×¢×•×¨×™ ×‘×™×ª', '×ª×›× ×•×ª', '××©×—×§', '××—×¨'];
        let children = [];
        let devices = [];
        let queue = [];
        let currentIndex = 0;
        let timerInterval = null;
        let currentSeconds = 0;
        let totalSeconds = 0;
        let isPaused = false;
        let rules = [];
        let activeSessions = {}; // Track active sessions per device
        let currentDeviceId = localStorage.getItem('deviceId') || generateDeviceId();
        let sessionBonuses = {}; // Temporary bonuses for current session
        let warningShown = false; // Track if warning was shown

        // Generate unique device ID
        function generateDeviceId() {
            const id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceId', id);
            return id;
        }

        // Multi-device session management
        function saveActiveSession() {
            if (queue.length === 0 || currentIndex >= queue.length) return;
            
            const sessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
            sessions[currentDeviceId] = {
                currentIndex,
                currentSeconds,
                totalSeconds,
                isPaused,
                queue,
                deviceName: getDeviceName(),
                lastUpdate: Date.now()
            };
            localStorage.setItem('activeSessions', JSON.stringify(sessions));
        }

        function loadActiveSessions() {
            try {
                const sessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
                // Clean old sessions (older than 1 hour)
                const now = Date.now();
                Object.keys(sessions).forEach(deviceId => {
                    if (now - sessions[deviceId].lastUpdate > 3600000) {
                        delete sessions[deviceId];
                    }
                });
                localStorage.setItem('activeSessions', JSON.stringify(sessions));
                return sessions;
            } catch (e) {
                return {};
            }
        }

        function getDeviceName() {
            const device = devices.find(d => d.id === parseInt(localStorage.getItem('selectedDeviceId')));
            return device ? device.name : '××›×©×™×¨ ' + currentDeviceId.substr(-4);
        }

        function showActiveSessions() {
            const sessions = loadActiveSessions();
            const sessionCount = Object.keys(sessions).length;
            
            if (sessionCount > 1) {
                const sessionInfo = Object.entries(sessions)
                    .filter(([id]) => id !== currentDeviceId)
                    .map(([id, session]) => {
                        const child = session.queue[session.currentIndex];
                        return `${session.deviceName}: ${child.name} (${formatTime(session.currentSeconds)}/${formatTime(session.totalSeconds)})`;
                    })
                    .join('\n');
                
                if (sessionInfo) {
                    console.log('ğŸ“± ××›×©×™×¨×™× ×¤×¢×™×œ×™× ××—×¨×™×:\n' + sessionInfo);
                }
            }
        }

        function updateActiveDevicesDisplay() {
            const sessions = loadActiveSessions();
            const activeDevicesInfo = document.getElementById('activeDevicesInfo');
            const activeDevicesList = document.getElementById('activeDevicesList');
            
            const otherSessions = Object.entries(sessions).filter(([id]) => id !== currentDeviceId);
            
            if (otherSessions.length > 0) {
                activeDevicesInfo.style.display = 'block';
                activeDevicesList.innerHTML = otherSessions.map(([id, session]) => {
                    const child = session.queue[session.currentIndex] || {};
                    const progress = session.totalSeconds > 0 
                        ? Math.round((session.currentSeconds / session.totalSeconds) * 100) 
                        : 0;
                    
                    return `
                        <div class="list-item" style="margin-bottom: 5px;">
                            <div>
                                <strong>${session.deviceName}</strong>
                                <span style="color: var(--text-secondary); margin-right: 10px;">
                                    ${child.name || '×œ× ×™×“×•×¢'} - ${formatTime(session.currentSeconds)}/${formatTime(session.totalSeconds)}
                                    ${session.isPaused ? 'â¸ï¸ ××•×©×”×”' : 'â–¶ï¸ ×¤×¢×™×œ'}
                                </span>
                            </div>
                            <div style="width: 100px; background: var(--bg-main); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${progress}%; height: 100%; background: var(--primary);"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                activeDevicesInfo.style.display = 'none';
            }
        }

        // Pre-defined rule templates
        const ruleTemplates = [
            {
                name: '×¢×•× ×© ×¢×œ ××™×—×•×¨',
                description: '×× × ×©××¨ ×¤×—×•×ª ××“×§×”, ×”×•×¨×“ ×“×§×” + 5 ×“×§×•×ª ××”×ª×•×¨ ×”×‘×',
                condition: 'overtime < 60',
                action: 'nextTurn - overtime - 300',
                enabled: true
            },
            {
                name: '×‘×•× ×•×¡ ×œ×™×¦×™××” ××”×™×¨×”',
                description: '×× ×™×¦× ×œ×¤× ×™ ×”×–××Ÿ, ×”×•×¡×£ ××ª ×”×–××Ÿ ×©× ×•×ª×¨ ×œ×ª×•×¨ ×”×‘×',
                condition: 'overtime < 0',
                action: 'nextTurn + Math.abs(overtime)',
                enabled: false
            },
            {
                name: '×¢×•× ×© ×§×©×” ×¢×œ ××™×—×•×¨',
                description: '×× × ×©××¨ ×™×•×ª×¨ ×-5 ×“×§×•×ª, ×”×•×¨×“ 10 ×“×§×•×ª ××”×ª×•×¨ ×”×‘×',
                condition: 'overtime > 300',
                action: 'nextTurn - 600',
                enabled: false
            },
            {
                name: '×—×œ×•×§×ª ×¢×•× ×© ×œ×›×•×œ×',
                description: '×× × ×©××¨ ×™×•×ª×¨ ××“×§×”, ×›×œ ×”×©××¨ ××§×‘×œ×™× ×‘×•× ×•×¡ ×©×œ ×“×§×”',
                condition: 'overtime > 60',
                action: 'allOthers + 60',
                enabled: false
            },
            {
                name: '×¢×•× ×© ×™×—×¡×™',
                description: '×”×•×¨×“ ××”×ª×•×¨ ×”×‘× ×¤×™ 2 ××”×–××Ÿ ×©× ×©××¨',
                condition: 'overtime > 0',
                action: 'nextTurn - (overtime * 2)',
                enabled: false
            },
            {
                name: '×‘×•× ×•×¡ ×œ×”×ª× ×”×’×•×ª ×˜×•×‘×”',
                description: '×× ×™×¦× ×‘×“×™×•×§ ×‘×–××Ÿ (×˜×•×•×— ×©×œ 30 ×©× ×™×•×ª), ×§×‘×œ 5 ×“×§×•×ª ×‘×•× ×•×¡ ×‘×ª×•×¨ ×”×‘×',
                condition: 'Math.abs(overtime) <= 30',
                action: 'nextTurn + 300',
                enabled: false
            }
        ];

        // Load from cookies on start
        // Wait for DOM to be ready before loading
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadFromCookies);
        } else {
            loadFromCookies();
        }

        // Initialize rules from templates if empty
        if (rules.length === 0) {
            rules = JSON.parse(JSON.stringify(ruleTemplates));
        }

        // Auto-save settings on change
        document.addEventListener('DOMContentLoaded', () => {
            const autoSaveInputs = ['priorityMode', 'defaultTime', 'allowPause', 'allowReset', 'showProgress', 'showPercent', 'countDown', 'soundAlerts', 'visualAlerts', 'warningTime', 'themeSelect'];
            autoSaveInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        saveSettings(true); // true = silent save
                    });
                }
            });
            
            renderRules();
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                
                // Update displays when switching tabs
                if (tab.dataset.tab === 'timer') {
                    updateActiveDevicesDisplay();
                    renderBonusSettings();
                }
            });
        });

        // Settings functions
        function saveSettings(silent = false) {
            settings.priorityMode = document.getElementById('priorityMode').checked;
            settings.defaultTime = parseInt(document.getElementById('defaultTime').value);
            settings.allowPause = document.getElementById('allowPause').checked;
            settings.allowReset = document.getElementById('allowReset').checked;
            settings.showProgress = document.getElementById('showProgress').checked;
            settings.showPercent = document.getElementById('showPercent').checked;
            settings.countDown = document.getElementById('countDown').checked;
            
            const soundAlerts = document.getElementById('soundAlerts');
            const visualAlerts = document.getElementById('visualAlerts');
            const warningTime = document.getElementById('warningTime');
            const themeSelect = document.getElementById('themeSelect');
            
            if (soundAlerts) settings.soundAlerts = soundAlerts.checked;
            if (visualAlerts) settings.visualAlerts = visualAlerts.checked;
            if (warningTime) settings.warningTime = parseInt(warningTime.value) || 2;
            if (themeSelect) {
                settings.theme = themeSelect.value;
                applyTheme(settings.theme);
            }
            
            saveToCookies();
            if (!silent) {
                alert('×”×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”! âœ…');
            }
            updateTimerControls();
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
        }

        function loadSettings() {
            document.getElementById('priorityMode').checked = settings.priorityMode;
            document.getElementById('defaultTime').value = settings.defaultTime;
            document.getElementById('allowPause').checked = settings.allowPause;
            document.getElementById('allowReset').checked = settings.allowReset;
            document.getElementById('showProgress').checked = settings.showProgress;
            document.getElementById('showPercent').checked = settings.showPercent;
            document.getElementById('countDown').checked = settings.countDown;
            
            const soundAlerts = document.getElementById('soundAlerts');
            const visualAlerts = document.getElementById('visualAlerts');
            const warningTime = document.getElementById('warningTime');
            const themeSelect = document.getElementById('themeSelect');
            
            if (soundAlerts) soundAlerts.checked = settings.soundAlerts !== false;
            if (visualAlerts) visualAlerts.checked = settings.visualAlerts !== false;
            if (warningTime) warningTime.value = settings.warningTime || 2;
            if (themeSelect) themeSelect.value = settings.theme || 'light';
            
            applyTheme(settings.theme || 'light');
        }

        // Category functions
        function renderCategories() {
            const list = document.getElementById('categoriesList');
            const select = document.getElementById('activityType');
            const childActivitySelect = document.getElementById('childActivity');
            const editChildActivitySelect = document.getElementById('editChildActivity');
            
            if (!list || !select) return; // Safety check
            
            list.innerHTML = categories.map((cat, i) => `
                <div class="list-item">
                    <span>${cat}</span>
                    ${i >= 4 ? `<button class="btn-danger" onclick="removeCategory(${i})">ğŸ—‘ï¸ ××—×§</button>` : ''}
                </div>
            `).join('');

            const categoryOptions = categories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');

            select.innerHTML = categoryOptions;
            if (childActivitySelect) {
                childActivitySelect.innerHTML = '<option value="">×œ× × ×‘×—×¨</option>' + categoryOptions;
            }
            if (editChildActivitySelect) {
                editChildActivitySelect.innerHTML = '<option value="">×œ× × ×‘×—×¨</option>' + categoryOptions;
            }
        }

        function addCategory() {
            const name = document.getElementById('newCategory').value.trim();
            if (!name) {
                alert('×× × ×”×›× ×¡ ×©× ×§×˜×’×•×¨×™×”');
                return;
            }
            
            categories.push(name);
            document.getElementById('newCategory').value = '';
            renderCategories();
            saveToCookies();
        }

        function removeCategory(index) {
            if (confirm('×”×× ×œ××—×•×§ ××ª ×”×§×˜×’×•×¨×™×”?')) {
                categories.splice(index, 1);
                renderCategories();
                saveToCookies();
            }
        }

        // Rules functions
        function renderRules() {
            const list = document.getElementById('rulesList');
            if (!list) return;

            list.innerHTML = rules.map((rule, index) => `
                <div class="rule-item ${!rule.enabled ? 'disabled' : ''}">
                    <div class="rule-header">
                        <div class="rule-name">${rule.name}</div>
                        <div class="rule-controls">
                            <label class="toggle-switch">
                                <input type="checkbox" ${rule.enabled ? 'checked' : ''} 
                                       onchange="toggleRule(${index})">
                                <span class="toggle-slider"></span>
                            </label>
                            ${index >= ruleTemplates.length ? 
                                `<button class="btn-danger" onclick="deleteRule(${index})" style="padding: 5px 10px; font-size: 0.8rem;">ğŸ—‘ï¸</button>` 
                                : ''}
                        </div>
                    </div>
                    <div class="rule-description">${rule.description}</div>
                    <div class="rule-formula">
                        <div><strong>×ª× ××™:</strong> ${rule.condition}</div>
                        <div><strong>×¤×¢×•×œ×”:</strong> ${rule.action}</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleRule(index) {
            rules[index].enabled = !rules[index].enabled;
            renderRules();
            saveToCookies();
        }

        function deleteRule(index) {
            if (confirm('×”×× ×œ××—×•×§ ××ª ×”×—×•×§?')) {
                rules.splice(index, 1);
                renderRules();
                saveToCookies();
            }
        }

        function openCustomRuleModal() {
            document.getElementById('customRuleModal').classList.add('active');
            document.getElementById('ruleName').value = '';
            document.getElementById('ruleDescription').value = '';
            document.getElementById('ruleCondition').value = '';
            document.getElementById('ruleAction').value = '';
        }

        function closeCustomRuleModal() {
            document.getElementById('customRuleModal').classList.remove('active');
        }

        function insertVariable(fieldId, value) {
            const field = document.getElementById(fieldId);
            const cursorPos = field.selectionStart;
            const textBefore = field.value.substring(0, cursorPos);
            const textAfter = field.value.substring(cursorPos);
            field.value = textBefore + value + textAfter;
            field.focus();
            field.setSelectionRange(cursorPos + value.length, cursorPos + value.length);
        }

        function saveCustomRule() {
            const name = document.getElementById('ruleName').value.trim();
            const description = document.getElementById('ruleDescription').value.trim();
            const condition = document.getElementById('ruleCondition').value.trim();
            const action = document.getElementById('ruleAction').value.trim();

            if (!name || !description || !condition || !action) {
                alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }

            rules.push({
                name,
                description,
                condition,
                action,
                enabled: true
            });

            renderRules();
            saveToCookies();
            closeCustomRuleModal();
            alert('×”×—×•×§ × ×•×¡×£ ×‘×”×¦×œ×—×”! âœ…');
        }

        function applyRules(childId, overtime) {
            const child = children.find(c => c.id === childId);
            if (!child) return;

            const defaultTurn = settings.defaultTime * 60; // in seconds
            let nextTurn = child.defaultTime * 60; // in seconds
            const activeRules = rules.filter(r => r.enabled);

            for (const rule of activeRules) {
                try {
                    // Evaluate condition
                    const conditionMet = eval(rule.condition);
                    
                    if (conditionMet) {
                        // Handle different action types
                        if (rule.action.includes('allOthers')) {
                            // Apply to all other children in queue
                            const bonus = eval(rule.action.replace('allOthers', '0'));
                            queue.forEach((qChild, idx) => {
                                if (idx > currentIndex && qChild.id !== childId) {
                                    qChild.timeAllotted += Math.floor(bonus / 60);
                                }
                            });
                        } else {
                            // Apply to next turn of current child
                            nextTurn = Math.max(60, eval(rule.action)); // minimum 1 minute
                        }

                        console.log(`Rule applied: ${rule.name}`);
                    }
                } catch (e) {
                    console.error(`Error applying rule "${rule.name}":`, e);
                }
            }

            // Update child's default time for next turn
            child.defaultTime = Math.floor(nextTurn / 60);
            saveToCookies();
            renderChildren();
        }

        // Children functions
        function addChild() {
            const name = document.getElementById('childName').value.trim();
            if (!name) {
                alert('×× × ×”×›× ×¡ ×©× ×™×œ×“');
                return;
            }

            const time = parseInt(document.getElementById('childTime').value) || settings.defaultTime;
            const activity = document.getElementById('childActivity').value;
            
            children.push({
                id: Date.now(),
                name: name,
                defaultTime: time,
                activity: activity,
                totalUsage: 0
            });

            document.getElementById('childName').value = '';
            document.getElementById('childTime').value = '';
            document.getElementById('childActivity').value = '';
            
            renderChildren();
            renderBonusSettings();
            saveToCookies();
        }

        function deleteChild(id) {
            if (confirm('×”×× ×œ××—×•×§ ××ª ×”×™×œ×“?')) {
                children = children.filter(c => c.id !== id);
                renderChildren();
                renderBonusSettings();
                saveToCookies();
            }
        }

        // Bonus settings for timer
        function renderBonusSettings() {
            const container = document.getElementById('bonusSettings');
            if (!container) return;

            if (children.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">××™×Ÿ ×™×œ×“×™× ×œ×”×¦×’×”. ×”×•×¡×£ ×™×œ×“×™× ×‘×˜××‘ "× ×™×”×•×œ"</p>';
                return;
            }

            container.innerHTML = children.map(child => `
                <div class="list-item" style="margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <strong>${child.name}</strong>
                        ${child.activity ? `<span class="category-badge category-${getCategoryClass(child.activity)}">${child.activity}</span>` : ''}
                        <span style="color: var(--text-secondary); margin-right: 10px;">
                            ×–××Ÿ ×‘×¡×™×¡×™: ${child.defaultTime} ×“×§×•×ª
                        </span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">×‘×•× ×•×¡:</label>
                        <input type="number" 
                               id="bonus-${child.id}" 
                               value="${sessionBonuses[child.id] || 0}" 
                               style="width: 80px; padding: 8px; border: 2px solid var(--border); border-radius: 5px;"
                               onchange="updateBonus(${child.id}, this.value)">
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">×“×§×•×ª</span>
                    </div>
                </div>
            `).join('');
        }

        function updateBonus(childId, value) {
            sessionBonuses[childId] = parseInt(value) || 0;
            saveTimerState();
        }

        // Statistics functions
        function showStatistics() {
            let stats = '<div style="max-height: 500px; overflow-y: auto;">';
            stats += '<h3 style="color: var(--primary);">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×™××•×©</h3>';
            
            if (children.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”');
                return;
            }
            
            const totalUsage = children.reduce((sum, child) => sum + child.totalUsage, 0);
            
            stats += `<p><strong>×¡×š ×”×›×œ ×©×¢×•×ª ×©×™××•×©:</strong> ${formatTime(totalUsage * 60)}</p>`;
            stats += '<hr style="border-color: var(--border); margin: 15px 0;">';
            
            children.forEach(child => {
                const percentage = totalUsage > 0 ? ((child.totalUsage / totalUsage) * 100).toFixed(1) : 0;
                stats += `
                    <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-main); border-radius: 8px;">
                        <strong>${child.name}</strong><br>
                        <span style="color: var(--text-secondary);">
                            ×©×™××•×©: ${formatTime(child.totalUsage * 60)} (${percentage}%)<br>
                            ×¤×¢×™×œ×•×ª: ${child.activity || '×œ× ×”×•×’×“×¨'}
                        </span>
                        <div style="width: 100%; background: var(--border); height: 8px; border-radius: 4px; margin-top: 5px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: var(--primary);"></div>
                        </div>
                    </div>
                `;
            });
            
            stats += '</div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.parentElement.parentElement.remove()">Ã—</span>
                    ${stats}
                    <button onclick="this.parentElement.parentElement.remove()" class="btn-secondary" style="margin-top: 15px;">×¡×’×•×¨</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function resetStatistics() {
            if (!confirm('×”×× ×œ××¤×¡ ××ª ×›×œ ×”×¡×˜×˜×™×¡×˜×™×§×•×ª? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”!')) return;
            
            children.forEach(child => child.totalUsage = 0);
            saveToCookies();
            renderChildren();
            alert('×”×¡×˜×˜×™×¡×˜×™×§×•×ª ××•×¤×¡×•! âœ…');
        }

        function exportData() {
            const exportData = {
                settings,
                categories,
                children,
                devices,
                rules,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `turn-system-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert('×”× ×ª×•× ×™× ×™×•×¦××• ×‘×”×¦×œ×—×”! ğŸ’¾');
        }

        function editChild(id) {
            const child = children.find(c => c.id === id);
            if (!child) return;

            document.getElementById('editChildId').value = child.id;
            document.getElementById('editChildName').value = child.name;
            document.getElementById('editChildTime').value = child.defaultTime;
            document.getElementById('editChildActivity').value = child.activity || '';
            
            document.getElementById('editChildModal').classList.add('active');
        }

        function saveEditChild() {
            const id = parseInt(document.getElementById('editChildId').value);
            const child = children.find(c => c.id === id);
            if (!child) return;

            child.name = document.getElementById('editChildName').value.trim();
            child.defaultTime = parseInt(document.getElementById('editChildTime').value) || settings.defaultTime;
            child.activity = document.getElementById('editChildActivity').value;

            renderChildren();
            renderBonusSettings();
            saveToCookies();
            closeEditChildModal();
            alert('×”×™×œ×“ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”! âœ…');
        }

        function closeEditChildModal() {
            document.getElementById('editChildModal').classList.remove('active');
        }

        function renderChildren() {
            const list = document.getElementById('childrenList');
            if (children.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">×˜×¨× × ×•×¡×¤×• ×™×œ×“×™×</p>';
                return;
            }

            list.innerHTML = children.map(child => `
                <div class="list-item">
                    <div>
                        <strong>${child.name}</strong>
                        ${child.activity ? `<span class="category-badge category-${getCategoryClass(child.activity)}">${child.activity}</span>` : ''}
                        <span style="color: var(--text-secondary); margin-right: 10px;">
                            ${child.defaultTime} ×“×§×•×ª
                            | ×©×™××•×© ×›×•×œ×œ: ${formatTime(child.totalUsage)}
                        </span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-warning" onclick="editChild(${child.id})" style="padding: 8px 15px; font-size: 0.9rem;">âœï¸ ×¢×¨×•×š</button>
                        <button class="btn-danger" onclick="deleteChild(${child.id})">ğŸ—‘ï¸ ××—×§</button>
                    </div>
                </div>
            `).join('');
        }

        // Device functions
        function addDevice() {
            const name = document.getElementById('deviceName').value.trim();
            if (!name) {
                alert('×× × ×”×›× ×¡ ×©× ××›×©×™×¨');
                return;
            }

            devices.push({
                id: Date.now(),
                name: name
            });

            document.getElementById('deviceName').value = '';
            renderDevices();
            saveToCookies();
        }

        function removeDevice(id) {
            if (confirm('×”×× ×œ××—×•×§ ××ª ×”××›×©×™×¨?')) {
                devices = devices.filter(d => d.id !== id);
                renderDevices();
                saveToCookies();
            }
        }

        function renderDevices() {
            const list = document.getElementById('devicesList');
            if (devices.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">×˜×¨× × ×•×¡×¤×• ××›×©×™×¨×™×</p>';
                return;
            }

            list.innerHTML = devices.map(device => `
                <div class="list-item">
                    <span>${device.name}</span>
                    <button class="btn-danger" onclick="removeDevice(${device.id})">ğŸ—‘ï¸ ××—×§</button>
                </div>
            `).join('');
        }

        // Bonus selection
        // Queue functions
        function startQueue() {
            if (children.length === 0) {
                alert('×× × ×”×•×¡×£ ×™×œ×“×™× ×œ×¤× ×™ ×”×ª×—×œ×ª ×”×ª×•×¨');
                return;
            }

            queue = [...children].map(child => {
                const bonus = sessionBonuses[child.id] || 0;
                return {
                    ...child,
                    timeAllotted: child.defaultTime + bonus,
                    activity: child.activity || '×œ× ×”×•×’×“×¨',
                    hasBonus: bonus !== 0
                };
            });

            // Priority mode sorting
            if (settings.priorityMode) {
                queue.sort((a, b) => {
                    const aPriority = (a.activity === '×©×™×¢×•×¨×™ ×‘×™×ª' || a.activity === '×ª×›× ×•×ª') ? 1 : 0;
                    const bPriority = (b.activity === '×©×™×¢×•×¨×™ ×‘×™×ª' || b.activity === '×ª×›× ×•×ª') ? 1 : 0;
                    return bPriority - aPriority;
                });
            } else {
                // Random shuffle
                shuffleArray(queue);
            }

            currentIndex = 0;
            document.getElementById('timerDisplay').style.display = 'block';
            renderQueue();
            loadCurrentChild();
            saveTimerState();
        }

        function shuffleQueue() {
            if (queue.length === 0) {
                alert('××™×Ÿ ×ª×•×¨ ×¤×¢×™×œ ×œ×¢×¨×‘×‘');
                return;
            }

            shuffleArray(queue);
            currentIndex = 0;
            renderQueue();
            loadCurrentChild();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderQueue() {
            const list = document.getElementById('queueList');
            list.innerHTML = queue.map((child, i) => `
                <div class="queue-item ${i === currentIndex ? 'active' : ''}">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="number">${i + 1}</div>
                        <div>
                            <strong>${child.name}</strong>
                            <span class="category-badge category-${getCategoryClass(child.activity)}">
                                ${child.activity}
                            </span>
                            ${child.hasBonus ? 'â­ ×‘×•× ×•×¡' : ''}
                        </div>
                    </div>
                    <div style="text-align: left;">
                        ${child.timeAllotted} ×“×§×•×ª
                    </div>
                </div>
            `).join('');
        }

        function getCategoryClass(activity) {
            const map = {
                '×©×™×¢×•×¨×™ ×‘×™×ª': 'homework',
                '×ª×›× ×•×ª': 'coding',
                '××©×—×§': 'gaming'
            };
            return map[activity] || 'other';
        }

        // Timer functions
        function loadCurrentChild() {
            if (queue.length === 0 || currentIndex >= queue.length) return;

            const child = queue[currentIndex];
            totalSeconds = child.timeAllotted * 60;
            currentSeconds = settings.countDown ? totalSeconds : 0;
            warningShown = false; // Reset warning for new child

            document.getElementById('currentChildName').textContent = 
                `${child.name} - ${child.activity}`;
            
            updateTimerDisplay();
            renderQueue();
            saveTimerState();
        }

        function startTimer() {
            if (timerInterval) return;

            isPaused = false;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = settings.allowPause ? 'inline-block' : 'none';

            timerInterval = setInterval(() => {
                if (settings.countDown) {
                    currentSeconds--;
                    if (currentSeconds <= 0) {
                        finishCurrentTurn();
                    }
                } else {
                    currentSeconds++;
                    if (currentSeconds >= totalSeconds) {
                        finishCurrentTurn();
                    }
                }
                updateTimerDisplay();
                saveActiveSession();
                saveTimerState(); // Save every second
            }, 1000);
            
            saveActiveSession();
            saveTimerState();
            showActiveSessions();
        }

        function pauseTimer() {
            if (!settings.allowPause) return;

            clearInterval(timerInterval);
            timerInterval = null;
            isPaused = true;

            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            
            saveTimerState();
        }

        function resetTimer() {
            if (!settings.allowReset) return;

            if (!confirm('×”×× ×œ××¤×¡ ××ª ×”×˜×™×™××¨?')) return;

            clearInterval(timerInterval);
            timerInterval = null;
            currentSeconds = settings.countDown ? totalSeconds : 0;
            isPaused = false;

            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';

            updateTimerDisplay();
            saveTimerState();
        }

        function nextChild() {
            if (!confirm('×”×× ×œ×¢×‘×•×¨ ×œ×™×œ×“ ×”×‘×?')) return;

            finishCurrentTurn();
        }

        function finishCurrentTurn() {
            clearInterval(timerInterval);
            timerInterval = null;

            // Calculate overtime (positive = stayed too long, negative = left early)
            const overtime = settings.countDown ? -currentSeconds : currentSeconds - totalSeconds;
            
            // Apply rules based on overtime
            applyRules(queue[currentIndex].id, overtime);

            // Update total usage
            const child = children.find(c => c.id === queue[currentIndex].id);
            if (child) {
                const actualTime = settings.countDown ? totalSeconds - currentSeconds : currentSeconds;
                child.totalUsage += Math.floor(actualTime / 60);
            }

            // Show overtime notification
            if (Math.abs(overtime) > 30) {
                const message = overtime > 0 
                    ? `â±ï¸ ${queue[currentIndex].name} × ×©××¨ ${Math.floor(overtime / 60)} ×“×§×•×ª ×•-${overtime % 60} ×©× ×™×•×ª ××¢×‘×¨ ×œ×–××Ÿ!`
                    : `âœ… ${queue[currentIndex].name} ×™×¦× ${Math.floor(Math.abs(overtime) / 60)} ×“×§×•×ª ×•-${Math.abs(overtime) % 60} ×©× ×™×•×ª ×œ×¤× ×™ ×”×–××Ÿ!`;
                
                showNotification(message, overtime > 0 ? 'danger' : 'success');
            }

            currentIndex++;
            
            if (currentIndex >= queue.length) {
                // Clear active session for this device
                const sessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
                delete sessions[currentDeviceId];
                localStorage.setItem('activeSessions', JSON.stringify(sessions));
                
                showCompletionDialog();
                return;
            }

            loadCurrentChild();
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            saveActiveSession();
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--${type});
                color: white;
                padding: 15px 30px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                animation: slideDown 0.5s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        function showCompletionDialog() {
            const sessions = loadActiveSessions();
            const otherActiveSessions = Object.keys(sessions).filter(id => id !== currentDeviceId).length;
            
            let message = '×›×œ ×”×™×œ×“×™× ×¡×™×™××•! ğŸ‰\n\n';
            
            if (otherActiveSessions > 0) {
                message += `×™×© ×¢×“×™×™×Ÿ ${otherActiveSessions} ××›×©×™×¨${otherActiveSessions > 1 ? '×™×' : ''} ×¤×¢×™×œ${otherActiveSessions > 1 ? '×™×' : ''}.\n\n`;
            }
            
            message += '×”×× ×œ×”×ª×—×™×œ ×ª×•×¨ ×—×“×©?';
            
            if (confirm(message)) {
                clearTimerState();
                startQueue();
            } else {
                document.getElementById('timerDisplay').style.display = 'none';
                queue = [];
                clearTimerState();
                saveToCookies();
                renderChildren();
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(currentSeconds / 60);
            const seconds = currentSeconds % 60;
            
            document.getElementById('timeDisplay').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Check for warning time
            const timeRemaining = settings.countDown ? currentSeconds : totalSeconds - currentSeconds;
            const warningSeconds = (settings.warningTime || 2) * 60;
            
            if (timeRemaining <= warningSeconds && timeRemaining > warningSeconds - 5 && !warningShown) {
                warningShown = true;
                showNotification(`â° × ×•×ª×¨×• ${settings.warningTime} ×“×§×•×ª!`, 'warning');
                if (settings.soundAlerts) playBeep();
                if (settings.visualAlerts) flashScreen();
            }
            
            // Reset warning flag when time increases again
            if (timeRemaining > warningSeconds) {
                warningShown = false;
            }

            // Progress bar
            const progress = (currentSeconds / totalSeconds) * 100;
            const displayProgress = settings.countDown ? 100 - progress : progress;
            
            if (settings.showProgress) {
                document.getElementById('progressContainer').style.display = 'block';
                document.getElementById('progressBar').style.width = displayProgress + '%';
                
                if (settings.showPercent) {
                    document.getElementById('percentDisplay').textContent = 
                        Math.round(displayProgress) + '%';
                } else {
                    document.getElementById('percentDisplay').textContent = '';
                }
            } else {
                document.getElementById('progressContainer').style.display = 'none';
            }

            // Stats
            const elapsed = settings.countDown ? totalSeconds - currentSeconds : currentSeconds;
            const remaining = settings.countDown ? currentSeconds : totalSeconds - currentSeconds;

            document.getElementById('elapsedTime').textContent = formatTime(elapsed);
            document.getElementById('remainingTime').textContent = formatTime(remaining);
        }

        function playBeep() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function flashScreen() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--warning);
                opacity: 0.3;
                z-index: 9999;
                pointer-events: none;
                animation: flash 0.5s ease-in-out 3;
            `;
            document.body.appendChild(overlay);
            
            setTimeout(() => overlay.remove(), 1500);
        }

        function updateTimerControls() {
            const pauseBtn = document.getElementById('pauseBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            if (!settings.allowPause && pauseBtn) {
                pauseBtn.style.display = 'none';
            }
            
            if (!settings.allowReset && resetBtn) {
                resetBtn.disabled = true;
                resetBtn.style.opacity = '0.5';
            } else if (resetBtn) {
                resetBtn.disabled = false;
                resetBtn.style.opacity = '1';
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        // Cookie functions
        function saveToCookies() {
            const data = {
                settings,
                categories,
                children,
                devices,
                rules
            };
            
            // Save to localStorage instead of cookies for better persistence
            localStorage.setItem('turnSystem', JSON.stringify(data));
            console.log('ğŸ’¾ × ×©××¨ ××•×˜×•××˜×™×ª ×œ-localStorage');
        }

        function saveTimerState() {
            const timerState = {
                queue,
                currentIndex,
                currentSeconds,
                totalSeconds,
                isPaused,
                sessionBonuses
            };
            localStorage.setItem('timerState_' + currentDeviceId, JSON.stringify(timerState));
            console.log('â±ï¸ ××¦×‘ ×”×˜×™×™××¨ × ×©××¨');
        }

        function loadTimerState() {
            try {
                const stateData = localStorage.getItem('timerState_' + currentDeviceId);
                if (stateData) {
                    const state = JSON.parse(stateData);
                    queue = state.queue || [];
                    currentIndex = state.currentIndex || 0;
                    currentSeconds = state.currentSeconds || 0;
                    totalSeconds = state.totalSeconds || 0;
                    isPaused = state.isPaused || false;
                    sessionBonuses = state.sessionBonuses || {};
                    
                    if (queue.length > 0 && currentIndex < queue.length) {
                        document.getElementById('timerDisplay').style.display = 'block';
                        renderQueue();
                        updateTimerDisplay();
                        
                        if (!isPaused) {
                            document.getElementById('startBtn').style.display = 'none';
                            document.getElementById('pauseBtn').style.display = 'inline-block';
                        }
                    }
                    
                    renderBonusSettings();
                }
            } catch (e) {
                console.error('Error loading timer state:', e);
            }
        }

        function clearTimerState() {
            localStorage.removeItem('timerState_' + currentDeviceId);
        }

        function loadFromCookies() {
            try {
                const data = localStorage.getItem('turnSystem');
                if (data && data.trim()) {
                    const parsed = JSON.parse(data);
                    settings = parsed.settings || settings;
                    categories = parsed.categories || categories;
                    children = parsed.children || [];
                    devices = parsed.devices || [];
                    rules = parsed.rules || JSON.parse(JSON.stringify(ruleTemplates));
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
                // Clear corrupted data
                localStorage.removeItem('turnSystem');
            }
            
            loadSettings();
            renderCategories();
            renderChildren();
            renderDevices();
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            renderCategories();
            renderChildren();
            renderDevices();
            renderBonusSettings();
            loadTimerState(); // Load saved timer state
            
            // Auto-refresh active devices display every 3 seconds when on timer tab
            setInterval(() => {
                const timerTab = document.getElementById('timer');
                if (timerTab && timerTab.classList.contains('active')) {
                    updateActiveDevicesDisplay();
                }
            }, 3000);
        });
    </script>
</body>
</html>